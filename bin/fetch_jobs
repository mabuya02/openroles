#!/usr/bin/env ruby
# Simple command to fetch jobs from all APIs and save to database

require_relative '../config/environment'

puts "ğŸš€ Starting comprehensive job fetch from all APIs..."
puts "=" * 60

# Check current job count
initial_count = Job.count
puts "ğŸ“Š Current jobs in database: #{initial_count}"
puts

# Initialize the TagBasedJobFetcherService with optimal settings
puts "ğŸ·ï¸  Initializing job fetcher with balanced tag strategy..."
service = TagBasedJobFetcherService.new(
  tag_strategy: 'balanced',              # Use balanced tags for good coverage
  max_tags: 25,                          # Use 25 different search terms
  sources: ['adzuna', 'jooble', 'remote_ok', 'remotive']  # All available APIs
)

puts "ğŸ” Fetching keywords from tags database..."
tags = Tag.get_fetching_keywords(strategy: 'balanced', limit: 25)
puts "ğŸ“ Using search terms: #{tags.join(', ')}"
puts

# Fetch jobs from all APIs
puts "ğŸŒ Fetching jobs from all APIs..."
puts "   â€¢ Adzuna API"
puts "   â€¢ Jooble API" 
puts "   â€¢ RemoteOK API"
puts "   â€¢ Remotive API"
puts

begin
  result = service.fetch_jobs_by_tags
  
  # Show results
  final_count = Job.count
  new_jobs = final_count - initial_count
  
  puts "âœ… Job fetch completed successfully!"
  puts "=" * 60
  puts "ğŸ“ˆ RESULTS:"
  puts "   â€¢ Jobs before: #{initial_count}"
  puts "   â€¢ Jobs after:  #{final_count}"
  puts "   â€¢ New jobs:    #{new_jobs}"
  puts "   â€¢ APIs used:   #{result[:sources_used] if result.is_a?(Hash)}"
  puts
  
  if new_jobs > 0
    puts "ğŸ‰ Successfully fetched #{new_jobs} new jobs!"
    
    # Show some stats about the new jobs
    recent_jobs = Job.limit(5).order(created_at: :desc)
    puts
    puts "ğŸ“‹ Latest jobs added:"
    recent_jobs.each_with_index do |job, index|
      puts "   #{index + 1}. #{job.title} at #{job.company&.name || 'Company'}"
    end
  else
    puts "â„¹ï¸  No new jobs found (might be duplicates or API limits reached)"
  end
  
rescue => e
  puts "âŒ Error occurred during job fetch:"
  puts "   #{e.message}"
  puts
  puts "ğŸ”§ Troubleshooting tips:"
  puts "   â€¢ Check your internet connection"
  puts "   â€¢ Verify API credentials in .env file"
  puts "   â€¢ Check if APIs have rate limits"
  puts "   â€¢ Ensure database is properly configured"
end

puts
puts "ğŸ Job fetch command completed!"
puts "=" * 60
